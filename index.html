<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>Web KTV Demo (é›¢ç·šç‰ˆ)</title>
  <style>
    body { font-family: sans-serif; background:#0b0f1a; color:#e8edf3; margin:20px; }
    #player { width:100%; max-width:800px; aspect-ratio:16/9; margin-bottom:10px; }
    input, button { padding:8px; margin:4px; }
    .queue { margin-top:20px; }
    .queue-item { padding:6px; border-bottom:1px solid #334; }
    #status { margin-top:10px; font-weight:bold; }
  </style>
</head>
<body>
  <h1>ðŸŽ¤ Web KTV Demo (é›¢ç·šç‰ˆ)</h1>
  <div id="player"></div>

  <button onclick="startPlayer()">ðŸ‘‰ é–‹å§‹æ’­æ”¾æŽˆæ¬Š</button>
  <p id="status" style="color:orange">ç­‰å¾…æ’­æ”¾å™¨è¼‰å…¥ä¸­â€¦</p>

  <div>
    <input id="urlInput" placeholder="è²¼ä¸Š YouTube é€£çµæˆ–å½±ç‰‡ ID" size="50" />
    <button onclick="addToQueue()">åŠ å…¥ä½‡åˆ—</button>
    <button onclick="playNext()">ä¸‹ä¸€é¦–</button>
  </div>

  <div class="queue">
    <h3>æ’­æ”¾ä½‡åˆ—</h3>
    <div id="queueList"></div>
  </div>

  <!-- ç›´æŽ¥å…§åµŒ YouTube IFrame API -->
  <script>
  // YouTube API Inline
  var YT, YTConfig;
  (function() {
    var l = window.location;
    YTConfig = {'host': l.protocol + "//www.youtube.com"};
    var e = document.createElement("script");
    e.src = YTConfig.host + "/s/player/38d0f4c7/www-widgetapi.vflset/www-widgetapi.js";
    e.async = true;
    var n = document.getElementsByTagName("script")[0];
    n.parentNode.insertBefore(e, n);
  })();
  </script>

  <script>
    let player;
    let queue = [];
    let current = null;
    let isReady = false;

    window.onYouTubeIframeAPIReady = () => {
      player = new YT.Player('player', {
        videoId: '',
        playerVars: { rel:0, modestbranding:1, playsinline:1 },
        events: {
          onReady: () => {
            isReady = true;
            document.getElementById("status").textContent = "âœ… æ’­æ”¾å™¨å·²æº–å‚™å®Œæˆï¼Œå¯ä»¥é–‹å§‹é»žæ­Œï¼";
            document.getElementById("status").style.color = "lightgreen";
          },
          onStateChange: e => {
            if (e.data === YT.PlayerState.ENDED) playNext();
          }
        }
      });
    };

    function parseId(url) {
      try {
        if (/^[0-9A-Za-z_-]{11}$/.test(url)) return url;
        let vParam = url.match(/[?&]v=([0-9A-Za-z_-]{11})/);
        if (vParam) return vParam[1];
        let shortUrl = url.match(/youtu\.be\/([0-9A-Za-z_-]{11})/);
        if (shortUrl) return shortUrl[1];
        let shortsUrl = url.match(/shorts\/([0-9A-Za-z_-]{11})/);
        if (shortsUrl) return shortsUrl[1];
        return null;
      } catch (e) {
        return null;
      }
    }

    function startPlayer() {
      if (player && player.playVideo) {
        player.playVideo();
        alert("æ’­æ”¾å™¨å·²å•Ÿç”¨ï¼Œå¯ä»¥é–‹å§‹é»žæ­Œäº†ï¼");
      } else {
        alert("æ’­æ”¾å™¨å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å€™å†è©¦ã€‚");
      }
    }

    function addToQueue() {
      let input = document.getElementById('urlInput');
      let id = parseId(input.value.trim());
      if (!id) return alert("ç„¡æ³•è§£æžå½±ç‰‡ï¼Œè«‹ç¢ºèªé€£çµæˆ– IDã€‚");
      queue.push({ id, title: input.value });
      input.value = "";
      renderQueue();
      if (!current) playNext();
    }

    function playNext() {
      if (!isReady) {
        alert("æ’­æ”¾å™¨å°šæœªæº–å‚™å¥½ï¼Œè«‹å…ˆæŒ‰ã€Žé–‹å§‹æ’­æ”¾æŽˆæ¬Šã€");
        return;
      }
      if (queue.length === 0) {
        current = null;
        if (player) player.stopVideo();
        renderQueue();
        return;
      }
      current = queue.shift();
      player.loadVideoById(current.id);
      renderQueue();
    }

    function renderQueue() {
      let qDiv = document.getElementById('queueList');
      qDiv.innerHTML = "";
      queue.forEach((q, i) => {
        let div = document.createElement("div");
        div.className = "queue-item";
        div.textContent = `${i+1}. ${q.title}`;
        qDiv.appendChild(div);
      });
    }
  </script>
</body>
</html>
