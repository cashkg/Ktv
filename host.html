<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>KTV Host</title>
</head>
<body style="background:#0b0f1a; color:#e8edf3; font-family:sans-serif; padding:20px;">

  <h1>ğŸ¤ KTV Hostï¼ˆå”±æ­Œç«¯ï¼‰</h1>
  <div id="status">â³ ç­‰å¾…è¼‰å…¥ä¸­â€¦</div>
  <div id="peer-info"></div>

  <!-- æ’­æ”¾å™¨ -->
  <div id="player" style="margin-top:12px; width:100%; max-width:640px; aspect-ratio:16/9;"></div>

  <!-- æ§åˆ¶æŒ‰éˆ• -->
  <div style="margin-top:12px;">
    <button onclick="playVideo()">â–¶ æ’­æ”¾</button>
    <button onclick="pauseVideo()">â¸ æš«åœ</button>
    <button onclick="nextSong()">â­ ä¸‹ä¸€é¦–</button>
  </div>

  <!-- ä½‡åˆ—é¡¯ç¤º -->
  <h3 style="margin-top:20px;">æ’­æ”¾ä½‡åˆ—</h3>
  <ul id="queue"></ul>

  <!-- YouTube API -->
  <script src="https://www.youtube.com/iframe_api"></script>
  <!-- PeerJS -->
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

  <script>
    let player, isReady = false;
    let queue = [];
    let current = null;
    let peer, conn;

    // YouTube åˆå§‹åŒ–
    function onYouTubeIframeAPIReady() {
      player = new YT.Player("player", {
        height: "360",
        width: "640",
        videoId: "",
        events: {
          onReady: () => {
            isReady = true;
            document.getElementById("status").innerText = "âœ… æ’­æ”¾å™¨å·²æº–å‚™å®Œæˆ";
          },
          onStateChange: (e) => {
            if (e.data === YT.PlayerState.ENDED) nextSong();
          }
        }
      });
    }

    function playVideo() { if (player) player.playVideo(); }
    function pauseVideo() { if (player) player.pauseVideo(); }

    function nextSong() {
      if (queue.length === 0) {
        current = null;
        player.stopVideo();
        renderQueue();
        return;
      }
      current = queue.shift();
      player.loadVideoById(current.videoId);
      renderQueue();
      syncState();
    }

    function addToQueue(item, insertNext=false) {
      if (insertNext) queue.unshift(item);
      else queue.push(item);
      if (!current) nextSong();
      renderQueue();
      syncState();
    }

    function renderQueue() {
      const q = document.getElementById("queue");
      q.innerHTML = "";
      queue.forEach((item, i) => {
        const li = document.createElement("li");
        li.textContent = `${i+1}. ${item.title}`;
        q.appendChild(li);
      });
    }

    // PeerJS åˆå§‹åŒ–
    peer = new Peer();
    peer.on("open", (id) => {
      document.getElementById("peer-info").innerText = `ğŸ“¡ Host Peer ID: ${id}`;
    });

    peer.on("connection", (c) => {
      conn = c;
      conn.on("data", (msg) => {
        if (msg.type === "enqueue") addToQueue(msg.payload);
        if (msg.type === "insertNext") addToQueue(msg.payload, true);
        if (msg.type === "play") playVideo();
        if (msg.type === "pause") pauseVideo();
        if (msg.type === "next") nextSong();
      });
    });

    function syncState() {
      if (conn && conn.open) {
        conn.send({ type:"sync", payload:{ queue, current } });
      }
    }
  </script>
</body>
</html>
