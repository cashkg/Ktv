<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>KTV Host</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;margin:0}
    header{position:sticky;top:0;background:#fff;z-index:5;border-bottom:1px solid #eee;padding:8px}
    .top{display:grid;grid-template-columns:1fr 260px;gap:12px;align-items:start}
    .playerBox,.sfxBox{background:#000;aspect-ratio:16/9;border-radius:8px;overflow:hidden}
    .tabs{display:flex;gap:8px;padding:8px}
    .tabs button{padding:6px 10px;border:1px solid #ccc;background:#f6f6f6;cursor:pointer}
    .tabs button.active{background:#e6f0ff;border-color:#8ab4ff}
    .tab{display:none;padding:8px} .tab.active{display:block}
    .queueRow{display:grid;grid-template-columns:42px 1fr 260px;gap:8px;align-items:center;border-bottom:1px solid #eee;padding:8px}
    .queueRow .idx{font-weight:600;text-align:center}
    .queueRow .ops button{margin:0 4px 4px 0;padding:6px;border:1px solid #bbb;background:#fff;cursor:pointer}
    .pill{padding:2px 8px;border:1px solid #ddd;border-radius:999px;background:#fafafa;font-size:12px;color:#666}
    .userRow{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;padding:8px}
    .dot{display:inline-block;width:8px;height:8px;border-radius:50%;}
  </style>
  <script>
    window.ROOM_ID = window.ROOM_ID || "ktv";
    window.APP_VERSION = window.APP_VERSION || "0.3";
    window.PIN_CODE = window.PIN_CODE || "1234";
    window.BGM_LIST = window.BGM_LIST || [
      { id:"5qap5aO4i9A", title:"LoFi BGM 1" },
      { id:"DWcJFNfaw9c", title:"LoFi BGM 2" }
    ];
  </script>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="host.js"></script>
</head>
<body>
  <header>
    <div class="top">
      <div class="playerBox"><div id="player"></div></div>
      <div>
        <div class="sfxBox"><div id="sfx-player"></div></div>
        <div style="margin-top:6px">
          <button onclick="KTV_HOST_API.playNext()">下一首</button>
          <span class="pill">房號：<b id="room-pill"></b></span>
          <span class="pill">版本：<b id="ver-pill"></b></span>
        </div>
        <div style="margin-top:6px">目前播放：<span id="nowTitle">(尚無)</span></div>
      </div>
    </div>
  </header>

  <nav class="tabs">
    <button data-tab="t-queue" class="active">待播清單</button>
    <button data-tab="t-history">歷史紀錄</button>
    <button data-tab="t-users">線上使用者</button>
  </nav>

  <section id="t-queue" class="tab active">
    <div id="queueList"></div>
  </section>

  <section id="t-history" class="tab">
    <div id="histList"></div>
  </section>

  <section id="t-users" class="tab">
    <div id="userList"></div>
  </section>

  <script>
    // 子頁籤
    document.querySelectorAll('.tabs button').forEach(btn=>{
      btn.onclick = ()=>{
        document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
      };
    });

    // YouTube IFrame API
    let player, sfxPlayer;
    window.onYouTubeIframeAPIReady = function(){
      player = new YT.Player('player', {
        width:'100%', height:'100%', videoId:'',
        playerVars:{ autoplay:1, controls:1, rel:0 },
        events:{
          onReady: ()=>{},
          onStateChange: (e)=>{ if (e.data === YT.PlayerState.ENDED) { try{ KTV_HOST_API.onVideoEnd(); }catch{} } }
        }
      });
      sfxPlayer = new YT.Player('sfx-player', {
        width:'100%', height:'100%', videoId:'',
        playerVars:{ autoplay:0, controls:0, rel:0 },
        events:{ onReady:()=>{} }
      });
      window.player = player;
      window.sfxPlayer = sfxPlayer;
    };

    // 渲染（供 host.js 呼叫）
    window.renderQueue = function(){
      const list = Array.isArray(window.KTV_QUEUE)? window.KTV_QUEUE : [];
      const box = document.getElementById('queueList'); box.innerHTML = "";
      list.forEach((it, i)=>{
        const row = document.createElement('div');
        row.className = "queueRow";
        row.innerHTML = `
          <div class="idx">${i+1}</div>
          <div>
            <div>${it.title||"(無標題)"} ${it.requester?`<span class="pill">by ${it.requester}</span>`:""}</div>
            <div style="font-size:12px;color:#666">ID: ${it.id||""}</div>
          </div>
          <div class="ops">
            <button onclick="moveUp(${i})">上移</button>
            <button onclick="moveDown(${i})">下移</button>
            <button onclick="insertAsNext(${i})">設為下一首</button>
            <button onclick="delAt(${i})">刪除</button>
          </div>`;
        box.append(row);
      });
    };
    window.renderNow = function(now){
      document.getElementById('nowTitle').textContent = now?.title || "(尚無)";
    };
    window.renderHistory = function(){
      const h = Array.isArray(window.KTV_HISTORY)? window.KTV_HISTORY : [];
      const box = document.getElementById('histList'); box.innerHTML = "";
      h.slice().reverse().forEach(it=>{
        const row = document.createElement('div');
        row.className = "queueRow";
        row.innerHTML = `
          <div class="idx">•</div>
          <div>
            <div>${it.title||"(無標題)"} ${it.requester?`<span class="pill">by ${it.requester}</span>`:""}</div>
            <div style="font-size:12px;color:#666">ID: ${it.id||""}</div>
          </div>
          <div class="ops"></div>`;
        box.append(row);
      });
    };
    window.renderPresence = function(map){
      const box = document.getElementById('userList'); box.innerHTML = "";
      const rows = Array.from(map.values()).sort((a,b)=>a.nick.localeCompare(b.nick));
      const now = Date.now();
      rows.forEach(u=>{
        const age = Math.max(0, Math.floor((now - u.lastSeen)/1000));
        const alive = age <= 8; // 8秒內視為在線
        const dot = `<span class="dot" style="background:${alive?'#22c55e':'#bbb'}"></span>`;
        const li = document.createElement('div');
        li.className = "userRow";
        li.innerHTML = `<div>${dot} <b>${u.nick}</b> <span class="pill">${u.id}</span></div><div style="color:#666;font-size:12px">${age}s</div>`;
        box.append(li);
      });
    };

    // 本地佇列操作
    function moveUp(i){
      const a = window.KTV_QUEUE; if (!Array.isArray(a) || i<=0) return;
      [a[i-1], a[i]] = [a[i], a[i-1]];
      renderQueue(); KTV_HOST_API.broadcastState();
    }
    function moveDown(i){
      const a = window.KTV_QUEUE; if (!Array.isArray(a) || i>=a.length-1) return;
      [a[i], a[i+1]] = [a[i+1], a[i]];
      renderQueue(); KTV_HOST_API.broadcastState();
    }
    function insertAsNext(i){
      const a = window.KTV_QUEUE; if (!Array.isArray(a) || i<0) return;
      const [x] = a.splice(i,1);
      a.splice(0,0,x);
      renderQueue(); KTV_HOST_API.broadcastState();
    }
    function delAt(i){
      const a = window.KTV_QUEUE; if (!Array.isArray(a) || i<0) return;
      a.splice(i,1);
      renderQueue(); KTV_HOST_API.broadcastState();
    }

    document.getElementById('room-pill').textContent = window.ROOM_ID;
    document.getElementById('ver-pill').textContent = window.APP_VERSION;
  </script>
</body>
</html>
