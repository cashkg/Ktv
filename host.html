<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>KTV Host</title>
</head>
<body style="background:#000; color:#eee; font-family:sans-serif; padding:20px;">

  <h1>🎤 KTV Host（播放端）</h1>
  <div id="peer-info"></div>
  <div id="conn-status" style="margin:5px 0; color:#0f0;"></div>

  <!-- 播放器 -->
  <div id="player" style="width:100%; max-width:640px; height:360px; background:#222;"></div>
  <div style="margin-top:10px;">
    <button onclick="playVideo()">▶ 播放</button>
    <button onclick="pauseVideo()">⏸ 暫停</button>
    <button onclick="stopVideo()">⏹ 停止</button>
    <button onclick="nextVideo()">⏭ 下一首</button>
  </div>

  <!-- 佇列 -->
  <h3>播放佇列</h3>
  <div id="queue"></div>

  <!-- PeerJS -->
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    let peer, conn;
    let queue = [];
    let currentVideo = null;
    let player;

    // 初始化 PeerJS
    peer = new Peer();
    peer.on("open", id => {
      document.getElementById("peer-info").innerText = "📡 Host Peer ID: " + id;
    });

    peer.on("connection", c => {
      conn = c;
      conn.on("open", () => {
        document.getElementById("conn-status").innerText = "✅ 已連線 Controller";
      });
      conn.on("data", msg => handleMsg(msg));
      conn.on("close", () => {
        document.getElementById("conn-status").innerText = "⚠️ Controller 已斷線";
      });
    });

    // 初始化 YouTube IFrame
    function onYouTubeIframeAPIReady() {
      player = new YT.Player("player", {
        height: "360",
        width: "640",
        events: {
          onReady: () => console.log("YouTube Player Ready"),
          onStateChange: e => {
            if (e.data === YT.PlayerState.ENDED) nextVideo();
          }
        }
      });
    }

    // 動態載入 YouTube API
    const tag = document.createElement("script");
    tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);

    // 播放控制
    function playVideo() { if (player) player.playVideo(); }
    function pauseVideo() { if (player) player.pauseVideo(); }
    function stopVideo() { if (player) player.stopVideo(); }
    function nextVideo() {
      if (queue.length > 0) {
        const next = queue.shift();
        playById(next.videoId, next.title);
      } else {
        currentVideo = null;
        document.getElementById("queue").innerText = "— 空 —";
      }
    }

    function playById(videoId, title) {
      currentVideo = { videoId, title };
      if (player) {
        player.loadVideoById(videoId);
        renderQueue();
      } else {
        alert("❌ 播放器尚未準備好");
      }
    }

    // 收到控制訊息
    function handleMsg(msg) {
      console.log("收到訊息:", msg);
      switch (msg.type) {
        case "enqueue":
          queue.push(msg.payload);
          if (!currentVideo) nextVideo();
          break;
        case "insertNext":
          queue.unshift(msg.payload);
          break;
        case "play": playVideo(); break;
        case "pause": pauseVideo(); break;
        case "next": nextVideo(); break;
      }
      renderQueue();
    }

    // 更新 UI
    function renderQueue() {
      document.getElementById("queue").innerHTML = queue.map((q, i) =>
        `<div>🎵 ${q.title} (${q.videoId})</div>`
      ).join("") || "— 空 —";
    }
  </script>
</body>
</html>
