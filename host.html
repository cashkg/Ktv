<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>KTV 主機端 (Host)</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0b0f1a; color:#e8edf3; margin:0; text-align:center; }
    header { padding:12px; border-bottom:1px solid #223; }
    h1 { font-size:20px; margin:0; }
    .card { padding:12px; border:1px solid #223; border-radius:12px; background:#0f1524; margin:12px auto; width:90%; max-width:700px; }
    .list { display:grid; gap:8px; max-height:45vh; overflow-y:auto; }
    .listItem { display:flex; justify-content:space-between; align-items:center; padding:8px; border:1px solid #223; border-radius:8px; }
    .btnSm { padding:6px 10px; border-radius:6px; border:1px solid #475569; background:#1f2937; color:#e8edf3; cursor:pointer; font-size:12px; }
  </style>
</head>
<body>
  <header>
    <h1>KTV 主機端 (Host)</h1>
    <div><b>Host Peer ID：</b> <span id="peer-id">初始化中...</span></div>
    <div>PIN 碼：<input id="pinInput" value="1234" size="6"/></div>
    <div id="status"></div>
  </header>

  <div class="card">
    <h3>現在播放</h3>
    <div id="nowPlaying">暫無</div>
    <div id="player" style="margin-top:10px;"></div>
    <div style="margin-top:10px;">
      <button class="btnSm" onclick="playVideo()">播放</button>
      <button class="btnSm" onclick="pauseVideo()">暫停</button>
      <button class="btnSm" onclick="stopVideo()">停止</button>
      <button class="btnSm" onclick="playNext()">下一首</button>
    </div>
  </div>

  <div class="card">
    <h3>播放佇列</h3>
    <div id="queue" class="list"></div>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    let player, sfxPlayer, peer;
    let conns = [];
    let queue=[], current=null, history=[];
    let hostPIN="1234";

    const hostId = new URLSearchParams(window.location.search).get("host") || "ktv-host";
    document.getElementById("peer-id").innerText = hostId;
    document.getElementById("pinInput").addEventListener("input", e=> hostPIN=e.target.value);

    const peerOptions = {
      host: "0.peerjs.com",
      port: 443,
      path: "/",
      secure: true,
      config: {
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:global.stun.twilio.com:3478?transport=udp" }
        ]
      }
    };

    function onYouTubeIframeAPIReady(){
      player=new YT.Player("player",{height:"360",width:"640",events:{
        onStateChange:(e)=>{ if(e.data===YT.PlayerState.ENDED) playNext(); }
      }});
      sfxPlayer=new YT.Player(document.createElement("div"),{height:"0",width:"0"});
    }

    peer=new Peer(hostId,peerOptions);
    peer.on("open", id=>document.getElementById("status").innerText=`✅ Host 啟動成功 (${id})`);
    peer.on("connection", c=>{
      conns.push(c);
      c.on("data", msg=>handleMsg(msg));
      c.on("close", cleanup);
      c.on("error", cleanup);
      sync();
    });

    function handleMsg(msg){
      switch(msg.type){
        case "enqueue": enqueue(msg.payload); break;
        case "insertNext": if(msg.pin===hostPIN) insertNext(msg.payload); break;
        case "removeAt": if(msg.pin===hostPIN) removeAt(msg.payload); break;
        case "next": if(msg.pin===hostPIN) playNext(); break;
        case "seek": if(player&&msg.pin===hostPIN) player.seekTo(msg.payload,true); break;
        case "sfx": playSFX(msg.payload); break;
      }
    }

    function enqueue(item){ queue.push(item); if(!current) playNext(); render(); sync(); }
    function insertNext(item){ queue.unshift(item); render(); sync(); }
    function removeAt(i){ queue.splice(i,1); render(); sync(); }

    function playNext(){
      if(current) history.push(current);
      if(queue.length===0){ current=null; document.getElementById("nowPlaying").innerText="暫無"; player.stopVideo(); sync(); return; }
      current=queue.shift();
      document.getElementById("nowPlaying").innerText=current.title;
      player.loadVideoById(current.videoId);
      render(); sync();
    }

    function playVideo(){ player.playVideo(); }
    function pauseVideo(){ player.pauseVideo(); }
    function stopVideo(){ player.stopVideo(); }

    function render(){
      const el=document.getElementById("queue"); el.innerHTML="";
      queue.forEach((q,i)=>el.innerHTML+=`<div class="listItem"><div>${q.title}</div>
        <button class="btnSm" onclick="removeAt(${i})">刪除</button></div>`);
    }

    function sync(){
      const payload={queue,current,history,needPIN:true};
      conns=conns.filter(c=>c.open); // ✅ 過濾死連線
      conns.forEach(c=>c.send({type:"sync",payload}));
    }
    function cleanup(){ conns=conns.filter(c=>c.open); }
    setInterval(sync,2000);

    function playSFX(type){
      const map={clap:"5dfqf6VZ2dA",cheer:"9Q7Vr3yQYWQ",boo:"RovF3pF3lHg"};
      if(map[type]) sfxPlayer.loadVideoById(map[type]);
    }
  </script>
</body>
</html>
