<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>TEST Host</title>
</head>
<body>
  <h2>TEST Host</h2>
  <div><b>Host Peer ID：</b> <span id="peer-id">初始化中...</span></div>
  <div id="status">啟動中...</div>

  <h3>已連線的 Clients：</h3>
  <ul id="clientList"></ul>

  <!-- PeerJS -->
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    const hostId = "ktv-host"; // 固定 ID
    document.getElementById("peer-id").innerText = hostId;

    const peer = new Peer(hostId, { 
      host:"0.peerjs.com", 
      port:443, 
      path:"/", 
      secure:true,
      config:{ iceServers:[{urls:"stun:stun.l.google.com:19302"}] }
    });

    const clients = new Map(); // {id: conn}

    function renderClients(){
      const el = document.getElementById("clientList");
      el.innerHTML = "";
      clients.forEach((c,id)=>{
        const li = document.createElement("li");
        li.innerText = id;
        el.appendChild(li);
      });
    }

    peer.on("open", id=>{
      document.getElementById("status").innerText = "✅ Host 啟動成功 (ID: " + id + ")";
    });

    peer.on("connection", conn=>{
      clients.set(conn.peer, conn);
      renderClients();
      document.getElementById("status").innerText = "📡 有 Client 連線: " + conn.peer;

      conn.on("data", msg=>{
        console.log("📩 收到 Client 訊息:", msg);
        // 回傳給該 Client
        conn.send({type:"hello", from:"Host", text:"已收到"});
      });

      conn.on("close", ()=>{
        clients.delete(conn.peer);
        renderClients();
        document.getElementById("status").innerText = "⚠️ Client 離線: " + conn.peer;
      });
    });

    peer.on("disconnected", ()=>{
      console.warn("Host 與 PeerJS 斷線，嘗試重連...");
      peer.reconnect();
    });

    peer.on("error", err=>{
      document.getElementById("status").innerText="❌ Host 錯誤: " + err;
      console.error(err);
    });
  </script>
</body>
</html>
