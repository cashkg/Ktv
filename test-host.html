<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>TEST Host</title>
</head>
<body>
  <h2>TEST Host</h2>
  <div><b>Host Peer IDï¼š</b> <span id="peer-id">åˆå§‹åŒ–ä¸­...</span></div>
  <div id="status">å•Ÿå‹•ä¸­...</div>

  <h3>å·²é€£ç·šçš„ Clientsï¼š</h3>
  <ul id="clientList"></ul>

  <!-- PeerJS -->
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    const hostId = "ktv-host"; // å›ºå®š ID
    document.getElementById("peer-id").innerText = hostId;

    const peer = new Peer(hostId, { 
      host:"0.peerjs.com", 
      port:443, 
      path:"/", 
      secure:true,
      config:{ iceServers:[{urls:"stun:stun.l.google.com:19302"}] }
    });

    const clients = new Map(); // {id: conn}

    function renderClients(){
      const el = document.getElementById("clientList");
      el.innerHTML = "";
      clients.forEach((c,id)=>{
        const li = document.createElement("li");
        li.innerText = id;
        el.appendChild(li);
      });
    }

    peer.on("open", id=>{
      document.getElementById("status").innerText = "âœ… Host å•Ÿå‹•æˆåŠŸ (ID: " + id + ")";
    });

    peer.on("connection", conn=>{
      clients.set(conn.peer, conn);
      renderClients();
      document.getElementById("status").innerText = "ğŸ“¡ æœ‰ Client é€£ç·š: " + conn.peer;

      conn.on("data", msg=>{
        console.log("ğŸ“© æ”¶åˆ° Client è¨Šæ¯:", msg);
        // å›å‚³çµ¦è©² Client
        conn.send({type:"hello", from:"Host", text:"å·²æ”¶åˆ°"});
      });

      conn.on("close", ()=>{
        clients.delete(conn.peer);
        renderClients();
        document.getElementById("status").innerText = "âš ï¸ Client é›¢ç·š: " + conn.peer;
      });
    });

    peer.on("disconnected", ()=>{
      console.warn("Host èˆ‡ PeerJS æ–·ç·šï¼Œå˜—è©¦é‡é€£...");
      peer.reconnect();
    });

    peer.on("error", err=>{
      document.getElementById("status").innerText="âŒ Host éŒ¯èª¤: " + err;
      console.error(err);
    });
  </script>
</body>
</html>
