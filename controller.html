<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>KTV Controller</title>
</head>
<body style="background:#111; color:#eee; font-family:sans-serif; padding:20px;">

  <h1>ğŸ“± KTV Controllerï¼ˆé»æ­Œç«¯ï¼‰</h1>
  <div id="conn-status" style="margin:5px 0;"></div>

  <!-- æœå°‹å€å¡Š -->
  <h3>æœå°‹æ­Œæ›²</h3>
  <input id="search" placeholder="è¼¸å…¥æ­Œåæˆ–æ­Œæ‰‹">
  <button onclick="searchYT()">æœå°‹</button>
  <div id="results" style="margin-top:10px;"></div>
  <div id="pager" style="margin-top:10px;"></div>

  <!-- æ§åˆ¶ -->
  <h3>æ§åˆ¶æ’­æ”¾</h3>
  <button onclick="sendToHost({type:'play'})">â–¶ æ’­æ”¾</button>
  <button onclick="sendToHost({type:'pause'})">â¸ æš«åœ</button>
  <button onclick="sendToHost({type:'next'})">â­ ä¸‹ä¸€é¦–</button>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    const API_KEY = "AIzaSyBOdPgWJQOZ1fswTgJRxA2RB3Awf_GrdAE"; // â† æ”¹æˆä½ çš„ API Key
    const hostId = "myKTVHost123"; // å›ºå®š ID
    let peer, conn, nextPageToken = null, prevPageToken = null;

    peer = new Peer();
    conn = peer.connect(hostId);
    conn.on("open", () => {
      document.getElementById("conn-status").innerText = "âœ… å·²é€£ç·š Host";
    });
    conn.on("error", err => {
      document.getElementById("conn-status").innerText = "âŒ ç„¡æ³•é€£ç·š Host";
      console.error(err);
    });

    function sendToHost(msg) {
      if (conn && conn.open) conn.send(msg);
      else alert("âŒ å°šæœªé€£ç·šåˆ° Host");
    }

    async function searchYT(pageToken="") {
      const query = document.getElementById("search").value.trim();
      if (!query) return alert("è«‹è¼¸å…¥é—œéµå­—");
      let url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=20&q=${encodeURIComponent(query)}&key=${API_KEY}`;
      if (pageToken) url += `&pageToken=${pageToken}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.error) return alert("âŒ æœå°‹å¤±æ•—ï¼š" + data.error.message);

        nextPageToken = data.nextPageToken || null;
        prevPageToken = data.prevPageToken || null;

        const list = data.items.map(item => {
          const vid = item.id.videoId;
          const title = item.snippet.title.replace(/'/g, "");
          const channel = item.snippet.channelTitle;
          const date = new Date(item.snippet.publishedAt).toLocaleDateString();
          const thumb = item.snippet.thumbnails?.default?.url || "";
          return `
            <div style="display:flex;gap:8px;align-items:center;margin:6px 0;border-bottom:1px solid #444;padding:4px;">
              <img src="${thumb}" alt="thumb" width="90" height="60">
              <div style="flex:1">
                <div style="font-weight:600">${title}</div>
                <div style="font-size:12px;opacity:0.7">${channel} Â· ${date}</div>
              </div>
              <button onclick="enqueue('${vid}','${title}')">ä½‡åˆ—</button>
              <button onclick="insertNext('${vid}','${title}')">æ’æ’­</button>
            </div>`;
        }).join("");

        document.getElementById("results").innerHTML = list || "â€” æ²’æ‰¾åˆ°çµæœ â€”";
        document.getElementById("pager").innerHTML = `
          ${prevPageToken ? `<button onclick="searchYT('${prevPageToken}')">â¬… ä¸Šä¸€é </button>` : ""}
          ${nextPageToken ? `<button onclick="searchYT('${nextPageToken}')">ä¸‹ä¸€é  â¡</button>` : ""}
        `;
      } catch (err) {
        alert("âŒ æœå°‹è«‹æ±‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API Key");
        console.error(err);
      }
    }

    function enqueue(videoId, title) { sendToHost({type:"enqueue", payload:{videoId, title}}); }
    function insertNext(videoId, title) { sendToHost({type:"insertNext", payload:{videoId, title}}); }
  </script>
</body>
</html>
