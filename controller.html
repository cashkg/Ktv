<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>KTV é»æ­Œæ§åˆ¶å™¨</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0b0f1a; color:#e8edf3; margin:0; }
    header { padding:12px; border-bottom:1px solid #223; text-align:center; }
    h1 { font-size:20px; margin:0; }
    .tab { display:none; padding:12px; }
    .card { padding:12px; border:1px solid #223; border-radius:12px; background:#0f1524; margin-bottom:12px; }
    .list { display:grid; gap:8px; max-height:45vh; overflow-y:auto; }
    .listItem { display:flex; justify-content:space-between; align-items:center; padding:8px; border:1px solid #223; border-radius:8px; }
    .btnSm { padding:4px 8px; font-size:12px; border-radius:6px; border:1px solid #475569; background:#1f2937; color:#e8edf3; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <h1>KTV é»æ­Œæ§åˆ¶å™¨</h1>
    <div id="status">ğŸ”„ å˜—è©¦é€£ç·š Host ä¸­...</div>
    <div>PIN ç¢¼ï¼š<input id="pinBox" placeholder="è¼¸å…¥ PIN"/></div>
    <div>
      <button onclick="switchTab('search')">æœå°‹ / é»æ­Œ</button>
      <button onclick="switchTab('charts')">æ’è¡Œæ¦œ</button>
      <button onclick="switchTab('favorites')">æ”¶è—</button>
      <button onclick="switchTab('history')">æ­·å²</button>
      <button onclick="switchTab('sfx')">éŸ³æ•ˆ</button>
    </div>
  </header>

  <div id="tab-search" class="tab" style="display:block;">
    <div class="card">
      <form id="searchForm">
        <input id="searchQuery" placeholder="æ­Œåã€æ­Œæ‰‹" style="width:70%;" />
        <button type="submit">æœå°‹</button>
      </form>
    </div>
    <div class="card"><div>æœå°‹çµæœ</div><div id="searchResults" class="list"></div></div>
    <div class="card"><div>æ’­æ”¾ä½‡åˆ—</div><div id="queue" class="list"></div></div>
  </div>

  <div id="tab-charts" class="tab">
    <h3>ç†±é–€æ’è¡Œæ¦œ</h3>
    <button onclick="loadChart('ytmusic')">YouTube Music</button>
    <button onclick="loadChart('spotify')">Spotify</button>
    <button onclick="loadChart('kkbox')">KKBOX</button>
    <button onclick="loadChart('apple')">Apple Music</button>
    <div id="charts-content" style="margin-top:10px;"></div>
  </div>

  <div id="tab-favorites" class="tab">
    <h3>æ”¶è—æ¸…å–®</h3>
    <div id="favoritesList" class="list"></div>
  </div>

  <div id="tab-history" class="tab">
    <h3>æ­·å²ç´€éŒ„</h3>
    <div id="historyList" class="list"></div>
  </div>

  <div id="tab-sfx" class="tab">
    <h3>éŸ³æ•ˆæŒ‰éˆ•</h3>
    <button class="btnSm" onclick="send({type:'sfx',payload:'clap'})">ğŸ‘ æŒè²</button>
    <button class="btnSm" onclick="send({type:'sfx',payload:'cheer'})">ğŸ™Œ æ­¡å‘¼</button>
    <button class="btnSm" onclick="send({type:'sfx',payload:'boo'})">ğŸ˜®â€ğŸ’¨ å™“è²</button>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    const API_KEY="ä½ çš„_YT_API_KEY"; // å»ºè­°æ”¾ Proxyï¼Œä¸è¦ç¡¬ç·¨ç¢¼
    let conn, queue=[], history=[], favorites=[], needPIN=false;

    const hostId = new URLSearchParams(window.location.search).get("host") || "ktv-host";
    const peerOptions = {
      host: "0.peerjs.com",
      port: 443,
      path: "/",
      secure: true,
      config: {
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:global.stun.twilio.com:3478?transport=udp" }
        ]
      }
    };

    function switchTab(tab){
      document.querySelectorAll(".tab").forEach(el=>el.style.display="none");
      document.getElementById("tab-"+tab).style.display="block";
      if(tab==="favorites") renderFavorites();
      if(tab==="history") renderHistory();
    }

    function connectWithRetry(attempt=1){
      const peer = new Peer(null, peerOptions);
      peer.on("open", id=>{
        document.getElementById("status").innerText=`ğŸ”Œ Peer å°±ç·’ (${id})`;
        conn = peer.connect(hostId);
        conn.on("open", ()=> document.getElementById("status").innerText=`âœ… å·²é€£ç·š Host(${hostId})`);
        conn.on("data", msg=>handleMsg(msg));
        conn.on("close", ()=>retry("closed"));
        conn.on("error", err=>retry(err));
      });
      peer.on("error", err=>retry(err));

      function retry(reason){
        if(attempt>8){ document.getElementById("status").innerText="âŒ ç„¡æ³•é€£ç·š Host"; return; }
        const delay=Math.pow(2,attempt)*500;
        document.getElementById("status").innerText=`âš ï¸ é€£ç·šå¤±æ•—ï¼Œ${delay/1000}s å¾Œé‡è©¦ (${attempt})`;
        setTimeout(()=>connectWithRetry(attempt+1),delay);
      }
    }

    function getPIN(){ return document.getElementById("pinBox").value; }
    function send(msg){ if(conn&&conn.open) conn.send(msg); else alert("æœªé€£ç·š Host"); }

    function handleMsg(msg){
      if(msg.type==="sync"){
        queue=msg.payload.queue||[];
        history=msg.payload.history||[];
        needPIN=msg.payload.needPIN;
        renderQueue();
      }
    }

    // æœå°‹åŠŸèƒ½ç•¥ï¼Œä¿ç•™åŸæœ¬ç¨‹å¼
    // æ”¶è—/æ­·å² render ä¹Ÿæ²¿ç”¨åŸæœ¬ç¨‹å¼
    // ...
    connectWithRetry();
  </script>
</body>
</html>
