<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>KTV 點歌控制器</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0b0f1a; color:#e8edf3; margin:0; }
    header { padding:12px; border-bottom:1px solid #223; text-align:center; }
    h1 { font-size:20px; margin:0; }
    .tab { display:none; padding:12px; }
    .card { padding:12px; border:1px solid #223; border-radius:12px; background:#0f1524; margin-bottom:12px; }
    .list { display:grid; gap:8px; max-height:45vh; overflow-y:auto; }
    .listItem { display:flex; justify-content:space-between; align-items:center; padding:8px; border:1px solid #223; border-radius:8px; }
    .listInfo { display:flex; align-items:center; gap:10px; }
    .thumb { width:80px; border-radius:6px; }
    .btnSm { padding:4px 8px; font-size:12px; border-radius:6px; border:1px solid #475569; background:#1f2937; color:#e8edf3; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <h1>KTV 點歌控制器</h1>
    <div id="status">🔄 嘗試連線 Host 中...</div>
    <div>PIN 碼：<input id="pinBox" placeholder="輸入 PIN"/></div>
    <div>
      <button onclick="switchTab('search')">搜尋 / 點歌</button>
      <button onclick="switchTab('charts')">排行榜</button>
      <button onclick="switchTab('favorites')">收藏</button>
      <button onclick="switchTab('history')">歷史</button>
      <button onclick="switchTab('sfx')">音效</button>
    </div>
  </header>

  <div id="tab-search" class="tab" style="display:block;">
    <div class="card">
      <!-- 搜尋按鈕放左邊 -->
      <form id="searchForm" onsubmit="return false;" style="display:flex; gap:8px;">
        <button type="button" onclick="doSearch()">搜尋</button>
        <input id="searchQuery" placeholder="歌名、歌手" style="flex:1;" />
      </form>
    </div>
    <div class="card"><div>搜尋結果</div><div id="searchResults" class="list"></div></div>
    <div class="card"><div>播放佇列</div><div id="queue" class="list"></div></div>
  </div>

  <div id="tab-charts" class="tab">
    <h3>熱門排行榜</h3>
    <button onclick="loadChart('ytmusic')">YouTube Music</button>
    <button onclick="loadChart('spotify')">Spotify</button>
    <button onclick="loadChart('kkbox')">KKBOX</button>
    <button onclick="loadChart('apple')">Apple Music</button>
    <div id="charts-content" style="margin-top:10px;"></div>
  </div>

  <div id="tab-favorites" class="tab">
    <h3>收藏清單</h3>
    <div id="favoritesList" class="list"></div>
  </div>

  <div id="tab-history" class="tab">
    <h3>歷史紀錄</h3>
    <div id="historyList" class="list"></div>
  </div>

  <div id="tab-sfx" class="tab">
    <h3>音效按鈕</h3>
    <button class="btnSm" onclick="send({type:'sfx',payload:'clap'})">👏 掌聲</button>
    <button class="btnSm" onclick="send({type:'sfx',payload:'cheer'})">🙌 歡呼</button>
    <button class="btnSm" onclick="send({type:'sfx',payload:'boo'})">😮‍💨 噓聲</button>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    const API_KEY="AIzaSyBOdPgWJQOZ1fswTgJRxA2RB3Awf_GrdAE";
    let conn, queue=[], history=[], favorites=[], needPIN=false;

    const hostId = new URLSearchParams(window.location.search).get("host") || "ktv-host";
    const peerOptions = {
      host: "0.peerjs.com",
      port: 443,
      path: "/",
      secure: true,
      config: {
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:global.stun.twilio.com:3478?transport=udp" }
        ]
      }
    };

    // 先鎖住所有按鈕，等連線成功再解鎖
    document.addEventListener("DOMContentLoaded", ()=>{
      document.querySelectorAll("button").forEach(b=>b.disabled=true);
    });

    function switchTab(tab){
      document.querySelectorAll(".tab").forEach(el=>el.style.display="none");
      document.getElementById("tab-"+tab).style.display="block";
      if(tab==="favorites") renderFavorites();
      if(tab==="history") renderHistory();
    }

    function connectWithRetry(attempt=1){
      const peer = new Peer(null, peerOptions);
      peer.on("open", id=>{
        document.getElementById("status").innerText=`🔌 Peer 就緒 (${id})`;
        conn = peer.connect(hostId);
        conn.on("open", ()=>{
          document.getElementById("status").innerText=`✅ 已連線 Host(${hostId})`;
          document.querySelectorAll("button").forEach(b=>b.disabled=false); // 解鎖按鈕
        });
        conn.on("data", msg=>handleMsg(msg));
        conn.on("close", ()=>retry("closed"));
        conn.on("error", err=>retry(err));
      });
      peer.on("error", err=>retry(err));

      function retry(reason){
        if(attempt>8){ document.getElementById("status").innerText="❌ 無法連線 Host"; return; }
        const delay=Math.pow(2,attempt)*500;
        document.getElementById("status").innerText=`⚠️ 連線失敗，${delay/1000}s 後重試 (${attempt})`;
        setTimeout(()=>connectWithRetry(attempt+1),delay);
      }
    }

    function getPIN(){ return document.getElementById("pinBox").value; }
    function send(msg){ if(conn && conn.open) conn.send(msg); }

    function handleMsg(msg){
      if(msg.type==="sync"){
        queue=msg.payload.queue||[];
        history=msg.payload.history||[];
        needPIN=msg.payload.needPIN;
        renderQueue();
      }
    }

    // 搜尋
    async function doSearch(){
      let q=document.getElementById("searchQuery").value;
      if(!q) return;
      try {
        let url=`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=10&q=${encodeURIComponent(q)}&key=${API_KEY}`;
        let res=await fetch(url);
        let data=await res.json();
        const el=document.getElementById("searchResults"); el.innerHTML="";
        (data.items||[]).forEach(it=>{
          let vid=it.id.videoId, title=it.snippet.title, thumb=it.snippet.thumbnails.default.url;
          el.innerHTML+=`<div class="listItem">
            <div class="listInfo">
              <img class="thumb" src="${thumb}" />
              <div>${title}</div>
            </div>
            <div>
              <button class="btnSm" onclick='send({type:"enqueue",payload:{videoId:"${vid}",title:"${title}"}})'>佇列</button>
              <button class="btnSm" onclick='send({type:"insertNext",pin:getPIN(),payload:{videoId:"${vid}",title:"${title}"}})'>插播</button>
              <button class="btnSm" onclick='addFavorite("${vid}","${title}")'>⭐ 收藏</button>
            </div>
          </div>`;
        });
      } catch(err){
        document.getElementById("searchResults").innerHTML=`<div style="color:red;">搜尋失敗: ${err}</div>`;
      }
    }

    function renderQueue(){
      const el=document.getElementById("queue"); el.innerHTML="";
      queue.forEach((q,i)=>{
        el.innerHTML+=`<div class="listItem"><div>${q.title}</div>
        <div>
          <button class="btnSm" onclick='send({type:"next",pin:getPIN()})'>立即播放</button>
          <button class="btnSm" onclick='send({type:"removeAt",pin:getPIN(),payload:${i}})'>刪除</button>
        </div></div>`;
      });
    }

    function addFavorite(id,title){
      favorites.push({videoId:id,title});
      localStorage.setItem("favorites",JSON.stringify(favorites));
      alert("已收藏："+title);
    }
    function renderFavorites(){
      favorites=JSON.parse(localStorage.getItem("favorites")||"[]");
      const el=document.getElementById("favoritesList"); el.innerHTML="";
      favorites.forEach(f=>{
        el.innerHTML+=`<div class="listItem"><div>${f.title}</div>
        <button class="btnSm" onclick='send({type:"enqueue",payload:${JSON.stringify(f)}})'>播放</button></div>`;
      });
    }

    function renderHistory(){
      const el=document.getElementById("historyList"); el.innerHTML="";
      history.forEach(h=>{
        el.innerHTML+=`<div class="listItem"><div>${h.title}</div>
        <button class="btnSm" onclick='send({type:"enqueue",payload:${JSON.stringify(h)}})'>再唱一次</button></div>`;
      });
    }

    function loadChart(source){
      let url="";
      switch(source){
        case "ytmusic": url="https://charts.youtube.com/charts/TrendingSongs/tw"; break;
        case "spotify": url="https://charts.spotify.com/charts/overview/global"; break;
        case "kkbox": url="https://kma.kkbox.com/charts/weekly/newrelease?lang=tc"; break;
        case "apple": url="https://music.apple.com/tw/browse/top-charts"; break;
      }
      document.getElementById("charts-content").innerHTML=`<iframe src="${url}" width="100%" height="600px"></iframe>`;
    }

    connectWithRetry();
  </script>
</body>
</html>
