<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>KTV é»æ­Œæ§åˆ¶å™¨</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0b0f1a; color:#e8edf3; margin:0; }
    header { padding:12px; border-bottom:1px solid #223; text-align:center; }
    h1 { font-size:20px; margin:0; }
    .tab { display:none; padding:12px; }
    .card { padding:12px; border:1px solid #223; border-radius:12px; background:#0f1524; margin-bottom:12px; }
    .list { display:grid; gap:8px; max-height:45vh; overflow-y:auto; }
    .listItem { display:flex; justify-content:space-between; align-items:center; padding:8px; border:1px solid #223; border-radius:8px; }
    .listInfo { display:flex; align-items:center; gap:10px; }
    .thumb { width:80px; border-radius:6px; }
    .btnSm { padding:4px 8px; font-size:12px; border-radius:6px; border:1px solid #475569; background:#1f2937; color:#e8edf3; cursor:pointer; margin-left:4px; }
    /* Toast */
    #toast { position:fixed; top:20px; right:20px; background:#1f2937; padding:10px 16px; border-radius:8px; border:1px solid #475569; color:#e8edf3; display:none; z-index:9999; }
  </style>
</head>
<body>
  <header>
    <h1>KTV é»æ­Œæ§åˆ¶å™¨</h1>
    <div id="status">ğŸ”„ å˜—è©¦é€£ç·š Host ä¸­...</div>
    <div>
      PIN ç¢¼ï¼š<input id="pinBox" placeholder="è¼¸å…¥ PIN"/>
      æš±ç¨±ï¼š<input id="nickname" placeholder="è¼¸å…¥æš±ç¨±"/>
    </div>
    <div>
      <button onclick="switchTab('search')">æœå°‹ / é»æ­Œ</button>
      <button onclick="switchTab('charts')">æ’è¡Œæ¦œ</button>
      <button onclick="switchTab('favorites')">æ”¶è—</button>
      <button onclick="switchTab('history')">æ­·å²</button>
      <button onclick="switchTab('queue')">æ’­æ”¾ä½‡åˆ—</button>
    </div>
  </header>

  <!-- æœå°‹ / é»æ­Œ -->
  <div id="tab-search" class="tab" style="display:block;">
    <div class="card" style="background:#1a2235; border:2px solid #475569;">
      <div><b>ğŸ¶ ç¾åœ¨æ’­æ”¾ï¼š</b> <span id="nowPlaying">æš«ç„¡</span></div>
      <div><b>â­ ä¸‹ä¸€é¦–ï¼š</b> <span id="nextSong">æš«ç„¡</span></div>
    </div>
    <div class="card">
      <form id="searchForm" onsubmit="return false;" style="display:flex; gap:8px;">
        <button type="button" onclick="doSearch()">æœå°‹</button>
        <input id="searchQuery" placeholder="æ­Œåã€æ­Œæ‰‹" style="flex:1;" />
      </form>
    </div>
    <div class="card"><div>æœå°‹çµæœ</div><div id="searchResults" class="list"></div></div>
  </div>

  <!-- æ’è¡Œæ¦œ -->
  <div id="tab-charts" class="tab">
    <h3>ç†±é–€æ’è¡Œæ¦œ</h3>
    <button onclick="openChart('ytmusic')">YouTube Music</button>
    <button onclick="openChart('spotify')">Spotify</button>
    <button onclick="openChart('kkbox')">KKBOX</button>
    <button onclick="openChart('apple')">Apple Music</button>
    <button onclick="openChart('cashbox')">éŒ¢æ«ƒ</button>
    <button onclick="openChart('holiday')">å¥½æ¨‚è¿ª</button>
    <button onclick="openChart('partyworld')">æ˜Ÿèšé»</button>
  </div>

  <!-- æ”¶è— -->
  <div id="tab-favorites" class="tab">
    <h3>æ”¶è—æ¸…å–®</h3>
    <button class="btnSm" onclick="clearFavorites()">ğŸ—‘ æ¸…é™¤å…¨éƒ¨æ”¶è—</button>
    <div id="favoritesList" class="list"></div>
  </div>

  <!-- æ­·å² -->
  <div id="tab-history" class="tab">
    <h3>æ­·å²ç´€éŒ„</h3>
    <button class="btnSm" onclick="clearHistory()">ğŸ—‘ æ¸…é™¤å…¨éƒ¨æ­·å²</button>
    <div id="historyList" class="list"></div>
  </div>

  <!-- æ’­æ”¾ä½‡åˆ—ï¼ˆåªè®€ï¼‰ -->
  <div id="tab-queue" class="tab">
    <h3>æ’­æ”¾ä½‡åˆ—</h3>
    <div id="queue" class="list"></div>
  </div>

  <!-- é‡è¤‡é»æ­Œæé†’ Modal -->
  <div id="duplicateModal" style="
    display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.6); backdrop-filter:blur(3px);
    justify-content:center; align-items:center; z-index:9999;
  ">
    <div style="background:#1f2937; padding:20px; border-radius:12px; width:300px; text-align:center; color:#e8edf3; border:1px solid #475569;">
      <h3>âš ï¸ é‡è¤‡é»æ­Œ</h3>
      <p id="duplicateSongTitle" style="margin:10px 0;">é€™é¦–æ­Œå·²å­˜åœ¨</p>
      <div style="margin-top:15px; display:flex; justify-content:space-around;">
        <button id="btnCancelDup" class="btnSm">å–æ¶ˆ</button>
        <button id="btnConfirmDup" class="btnSm" style="background:#2563eb; border-color:#2563eb;">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    const API_KEY="AIzaSyBOdPgWJQOZ1fswTgJRxA2RB3Awf_GrdAE";
    let conn, queue=[], history=[], favorites=[], needPIN=false;
    let pendingDuplicate=null;

    // éº»å°‡æš±ç¨±é è¨­
    const mahjongNames=["ä¸€è¬","äºŒè¬","ä¸‰è¬","å››è¬","äº”è¬","å…­è¬","ä¸ƒè¬","å…«è¬","ä¹è¬","ä¸€ç­’","äºŒç­’","ä¸‰ç­’","å››ç­’","äº”ç­’","å…­ç­’","ä¸ƒç­’","å…«ç­’","ä¹ç­’","ä¸€æ¢","äºŒæ¢","ä¸‰æ¢","å››æ¢","äº”æ¢","å…­æ¢","ä¸ƒæ¢","å…«æ¢","ä¹æ¢","æ±","å—","è¥¿","åŒ—","ä¸­","ç™¼","ç™½"];
    if(!localStorage.getItem("nickname")){
      const rand=mahjongNames[Math.floor(Math.random()*mahjongNames.length)];
      localStorage.setItem("nickname",rand);
    }
    document.addEventListener("DOMContentLoaded", ()=>{
      document.getElementById("nickname").value=localStorage.getItem("nickname");
    });

    const hostId = new URLSearchParams(window.location.search).get("host") || "ktv-host";
    const peerOptions = { host:"0.peerjs.com", port:443, path:"/", secure:true, config:{ iceServers:[{urls:"stun:stun.l.google.com:19302"}] } };

    function switchTab(tab){
      document.querySelectorAll(".tab").forEach(el=>el.style.display="none");
      document.getElementById("tab-"+tab).style.display="block";
      if(tab==="favorites") renderFavorites();
      if(tab==="history") renderHistory();
      if(tab==="queue") renderQueue();
    }

    function connectWithRetry(attempt=1){
      const peer = new Peer(null, peerOptions);
      peer.on("open", id=>{
        document.getElementById("status").innerText=`ğŸ”Œ Peer å°±ç·’ (${id})`;
        conn = peer.connect(hostId);
        conn.on("open", ()=>{
          document.getElementById("status").innerText=`âœ… å·²é€£ç·š Host(${hostId})`;
        });
        conn.on("data", msg=>handleMsg(msg));
        conn.on("close", ()=>retry("closed"));
        conn.on("error", err=>retry(err));
      });
      peer.on("error", err=>retry(err));

      function retry(reason){
        if(attempt>8){ document.getElementById("status").innerText="âŒ ç„¡æ³•é€£ç·š Host"; return; }
        const delay=Math.pow(2,attempt)*500;
        document.getElementById("status").innerText=`âš ï¸ é€£ç·šå¤±æ•—ï¼Œ${delay/1000}s å¾Œé‡è©¦ (${attempt})`;
        setTimeout(()=>connectWithRetry(attempt+1),delay);
      }
    }

    function getPIN(){ return document.getElementById("pinBox").value; }
    function getNickname(){ 
      const v=document.getElementById("nickname").value || "åŒ¿å";
      localStorage.setItem("nickname",v);
      return v;
    }
    function send(msg){ if(conn && conn.open) conn.send(msg); }

    function handleMsg(msg){
      if(msg.type==="sync"){
        queue=msg.payload.queue||[];
        history=msg.payload.history||[];
        needPIN=msg.payload.needPIN;
        document.getElementById("nowPlaying").innerText = msg.payload.current ? msg.payload.current.title+(msg.payload.current.by?" - by "+msg.payload.current.by:"") : "æš«ç„¡";
        document.getElementById("nextSong").innerText = (queue.length>0) ? queue[0].title+(queue[0].by?" - by "+queue[0].by:"") : "æš«ç„¡";
        renderQueue(); renderHistory();
      }
      if(msg.type==="confirmEnqueue"){
        pendingDuplicate=msg.payload;
        document.getElementById("duplicateSongTitle").innerText=`è¦é‡è¤‡é»æ’­ã€Š${pendingDuplicate.title}ã€‹å—ï¼Ÿ`;
        document.getElementById("duplicateModal").style.display="flex";
      }
    }

    document.getElementById("btnCancelDup").onclick=()=>{
      pendingDuplicate=null;
      document.getElementById("duplicateModal").style.display="none";
    };
    document.getElementById("btnConfirmDup").onclick=()=>{
      if(pendingDuplicate){
        send({type:"forceEnqueue", payload:pendingDuplicate});
        pendingDuplicate=null;
      }
      document.getElementById("duplicateModal").style.display="none";
    };

    async function doSearch(){
      let q=document.getElementById("searchQuery").value;
      if(!q) return;
      try {
        let url=`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=10&q=${encodeURIComponent(q)}&key=${API_KEY}`;
        let res=await fetch(url);
        let data=await res.json();
        const el=document.getElementById("searchResults"); el.innerHTML="";
        (data.items||[]).forEach(it=>{
          let vid=it.id.videoId, title=it.snippet.title, thumb=it.snippet.thumbnails.default.url;
          el.innerHTML+=`<div class="listItem">
            <div class="listInfo"><img class="thumb" src="${thumb}" /><div>${title}</div></div>
            <div>
              <button class="btnSm" onclick='enqueueSong("${vid}","${title}")'>ä½‡åˆ—</button>
              <button class="btnSm" onclick='send({type:"insertNext",pin:getPIN(),payload:{videoId:"${vid}",title:"${title}",by:getNickname()}})'>æ’æ’­</button>
              <button class="btnSm" onclick='addFavorite("${vid}","${title}")'>â­ æ”¶è—</button>
            </div>
          </div>`;
        });
      } catch(err){
        document.getElementById("searchResults").innerHTML=`<div style="color:red;">æœå°‹å¤±æ•—: ${err}</div>`;
      }
    }

    function enqueueSong(id,title){
      send({type:"enqueue",payload:{videoId:id,title:title,by:getNickname()}});
      showToast("âœ… å·²é€å‡ºï¼š"+title);
    }

    function renderQueue(){
      const el=document.getElementById("queue"); el.innerHTML="";
      queue.forEach(q=>{ el.innerHTML+=`<div class="listItem"><div>${q.title}${q.by?" - by "+q.by:""}</div></div>`; });
    }

    function addFavorite(id,title){
      favorites.push({videoId:id,title});
      localStorage.setItem("favorites",JSON.stringify(favorites));
      alert("å·²æ”¶è—ï¼š"+title);
    }
    function renderFavorites(){
      favorites=JSON.parse(localStorage.getItem("favorites")||"[]");
      const el=document.getElementById("favoritesList"); el.innerHTML="";
      favorites.forEach(f=>{
        el.innerHTML+=`<div class="listItem"><div>${f.title}</div>
        <button class="btnSm" onclick='send({type:"enqueue",payload:{videoId:"${f.videoId}",title:"${f.title}",by:getNickname()}})'>æ’­æ”¾</button></div>`;
      });
    }
    function clearFavorites(){ favorites=[]; localStorage.removeItem("favorites"); renderFavorites(); }

    function renderHistory(){
      const el=document.getElementById("historyList"); el.innerHTML="";
      history.slice().reverse().forEach(h=>{
        el.innerHTML+=`<div class="listItem"><div>${h.title}${h.by?" - by "+h.by:""}</div>
        <button class="btnSm" onclick='send({type:"enqueue",payload:{videoId:"${h.videoId}",title:"${h.title}",by:getNickname()}})'>å†å”±ä¸€æ¬¡</button></div>`;
      });
    }
    function clearHistory(){ history=[]; renderHistory(); send({type:"clearHistory", pin:getPIN()}); }

    function openChart(source){
      let url="";
      switch(source){
        case "ytmusic": url="https://charts.youtube.com/charts/TrendingSongs/tw"; break;
        case "spotify": url="https://spotifycharts.com/regional"; break;
        case "kkbox": url="https://kma.kkbox.com/charts/weekly/newrelease?lang=tc"; break;
        case "apple": url="https://music.apple.com/tw/browse/top-charts"; break;
        case "cashbox": url="https://www.cashboxparty.com.tw/Ranking"; break;
        case "holiday": url="https://www.holiday.com.tw/Rank"; break;
        case "partyworld": url="https://www.partyworldktv.com.tw/Rank"; break;
      }
      if(url) window.open(url,"_blank");
    }

    function showToast(msg){
      const el=document.getElementById("toast");
      el.innerText=msg;
      el.style.display="block";
      setTimeout(()=>{ el.style.display="none"; },2000);
    }

    connectWithRetry();
  </script>
</body>
</html>