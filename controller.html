<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KTV Controller</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{font-family:system-ui,Segoe UI,Arial;max-width:960px;margin:0 auto;padding:12px;}
    header{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .tabs{display:flex;gap:8px;margin:12px 0;}
    .tabs button{padding:6px 10px;border:1px solid #ccc;background:#f6f6f6;cursor:pointer}
    .tabs button.active{background:#e6f0ff;border-color:#8ab4ff}
    .tab{display:none} .tab.active{display:block}
    .row{display:grid;grid-template-columns:96px 1fr;gap:8px;align-items:center;border-bottom:1px solid #eee;padding:8px 0}
    .leftBtns{display:flex;flex-direction:column;gap:6px}
    .leftBtns button{padding:6px;border:1px solid #bbb;background:#fff;cursor:pointer}
    .result{display:grid;grid-template-columns:110px 1fr;gap:10px;align-items:center}
    .result img{width:110px;height:62px;object-fit:cover;border-radius:6px;border:1px solid #ddd}
    .list{margin-top:8px}
    .nick{display:flex;align-items:center;gap:6px}
    input[type=text]{padding:6px;border:1px solid #ccc;border-radius:6px;min-width:180px}
    .kv{display:flex;gap:8px;align-items:center}
    iframe{width:100%;height:68vh;border:1px solid #ddd;border-radius:8px}
    .pill{padding:2px 8px;border:1px solid #ddd;border-radius:999px;background:#fafafa;font-size:12px;color:#666}
  </style>
  <script>
    window.ROOM_ID = window.ROOM_ID || "ktv";
    window.APP_VERSION = window.APP_VERSION || "0.2";
    // 已內嵌你的金鑰
    window.YT_API_KEY = "AIzaSyBOdPgWJQOZ1fswTgJRxA2RB3Awf_GrdAE";
  </script>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script src="controller.js"></script>
</head>
<body>
  <header>
    <h2 style="margin:0">點歌端</h2>
    <span class="pill">房號：<b id="room-pill"></b></span>
    <span class="pill">版本：<b id="ver-pill"></b></span>
    <div class="nick">
      暱稱：
      <input id="nick" type="text" placeholder="麻將花色暱稱" />
      <button id="saveNick">儲存</button>
    </div>
  </header>

  <nav class="tabs">
    <button data-tab="t-search" class="active">搜尋歌曲</button>
    <button data-tab="t-history">歷史紀錄</button>
    <button data-tab="t-rank">KTV 排行榜</button>
  </nav>

  <section id="t-search" class="tab active">
    <div class="kv">
      <input id="q" type="text" placeholder="輸入歌名或歌手" />
      <button id="btnSearch">搜尋</button>
    </div>
    <div id="results" class="list"></div>
  </section>

  <section id="t-history" class="tab">
    <div id="histList" class="list"></div>
  </section>

  <section id="t-rank" class="tab">
    <div class="kv">
      <select id="rankSel">
        <option value="">請選擇排行榜頁面</option>
        <option value="https://www.youtube.com/feed/music">YouTube 音樂熱門</option>
        <option value="https://charts.youtube.com/charts/TopSongs/tw">YouTube 排行</option>
      </select>
      <button id="openRank">開啟</button>
    </div>
    <div style="margin-top:8px">
      <iframe id="rankFrame" src="about:blank"></iframe>
    </div>
  </section>

  <script>
    const NICKS = ["東風","南風","西風","北風","紅中","發財","白板","春","夏","秋","冬","梅","蘭","竹","菊"];
    function genNick(){ return NICKS[(Math.random()*NICKS.length)|0] + "-" + (100+((Math.random()*900)|0)); }
    const nickInput = document.getElementById('nick');
    const saveNickBtn = document.getElementById('saveNick');
    function loadNick(){
      const saved = localStorage.getItem('ktv_nick');
      const base = saved && saved.trim() ? saved.trim() : genNick();
      localStorage.setItem('ktv_nick_base', base);
      nickInput.value = saved ?? base;
    }
    function getNick(){
      const base = localStorage.getItem('ktv_nick_base') || genNick();
      const cur = (nickInput.value||"").trim();
      if (!cur) { nickInput.value = base; localStorage.setItem('ktv_nick', base); return base; }
      return cur;
    }
    saveNickBtn.onclick = () => { const n=getNick(); localStorage.setItem('ktv_nick', n); };

    document.querySelectorAll('.tabs button').forEach(btn=>{
      btn.onclick = ()=>{
        document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
      };
    });

    const q = document.getElementById('q');
    const btnSearch = document.getElementById('btnSearch');
    const results = document.getElementById('results');

    async function searchYT(){
      const key = window.YT_API_KEY;
      if (!key){ alert("尚未設定 YouTube API Key"); return; }
      const query = (q.value||"").trim();
      if (!query) return;
      results.innerHTML = "搜尋中…";
      try{
        const url = new URL("https://www.googleapis.com/youtube/v3/search");
        url.searchParams.set("part","snippet");
        url.searchParams.set("maxResults","25");
        url.searchParams.set("q", query);
        url.searchParams.set("type","video");
        url.searchParams.set("key", key);
        const r = await fetch(url);
        const j = await r.json();
        if (!Array.isArray(j.items)){ results.textContent="無結果"; return; }
        renderResults(j.items.map(it=>({
          id: it.id.videoId,
          title: it.snippet.title,
          thumb: it.snippet.thumbnails?.medium?.url || it.snippet.thumbnails?.default?.url || "",
        })));
      }catch(e){
        console.error(e); results.textContent="搜尋失敗";
      }
    }
    btnSearch.onclick = searchYT;

    function renderResults(list){
      results.innerHTML = "";
      list.forEach(item=>{
        const row = document.createElement('div');
        row.className = "row";
        const btns = document.createElement('div');
        btns.className = "leftBtns";
        const bInsert = document.createElement('button'); bInsert.textContent = "插播";
        const bAdd = document.createElement('button'); bAdd.textContent = "加入";
        btns.append(bInsert,bAdd);

        const info = document.createElement('div');
        info.className = "result";
        info.innerHTML = `<img src="${item.thumb}" alt=""><div><div>${item.title}</div><div style="font-size:12px;color:#666">ID: ${item.id}</div></div>`;

        row.append(btns, info);
        results.append(row);

        const payload = { id:item.id, title:item.title, thumb:item.thumb, requester:getNick() };
        bAdd.onclick    = () => tryEnqueue(payload, "enqueue");
        bInsert.onclick = () => tryEnqueue(payload, "insertNext", true);
      });
    }

    function isDuplicate(videoId){
      const now = (window.KTV_NOW?.id)||"";
      if (now === videoId) return true;
      const q = Array.isArray(window.KTV_QUEUE)? window.KTV_QUEUE : [];
      if (q.some(x=>x?.id===videoId)) return true;
      const h = Array.isArray(window.KTV_HISTORY)? window.KTV_HISTORY : [];
      if (h.slice(-10).some(x=>x?.id===videoId)) return true;
      return false;
    }
    function tryEnqueue(item, type="enqueue", needPin=false){
      const dup = isDuplicate(item.id);
      if (dup){
        if (!confirm("此歌曲已在佇列/當前/近期歷史中，仍要加入嗎？")) return;
      }
      const pin = needPin ? prompt("請輸入管理 PIN（可略過）","") : undefined;
      const sendItem = { ...item, requester:getNick() };
      if (type==="insertNext") window.ktvInsertNext(sendItem, pin);
      else window.ktvEnqueue(sendItem);
    }

    window.renderHistory = function(){
      const box = document.getElementById('histList');
      const hist = Array.isArray(window.KTV_HISTORY)? window.KTV_HISTORY : [];
      box.innerHTML = "";
      hist.slice().reverse().forEach((it)=>{
        const row = document.createElement('div');
        row.className = "row";
        row.innerHTML = `<div class="leftBtns"></div>
          <div><div>${it.title||"(無標題)"} ${it.requester?`<span class="pill">by ${it.requester}</span>`:""}</div>
          <div style="font-size:12px;color:#666">ID: ${it.id||""}</div></div>`;
        box.append(row);
      });
    };

    document.getElementById('openRank').onclick = ()=>{
      const url = document.getElementById('rankSel').value;
      if (!url) return;
      document.getElementById('rankFrame').src = url;
    };

    document.getElementById('room-pill').textContent = window.ROOM_ID;
    document.getElementById('ver-pill').textContent = window.APP_VERSION;
    loadNick();
  </script>
</body>
</html>
