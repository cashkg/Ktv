<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>KTV 點歌控制器</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0b0f1a; color:#e8edf3; margin:0; }
    header { padding:12px; border-bottom:1px solid #223; }
    h1 { font-size:20px; margin:0; }
    nav { margin-top:8px; display:flex; gap:10px; }
    nav button { padding:8px 12px; border-radius:8px; border:1px solid #475569; background:#1f2937; color:#e8edf3; cursor:pointer; }
    .tab { display:none; padding:12px; }
    .card { padding:12px; border:1px solid #223; border-radius:12px; background:#0f1524; margin-bottom:12px; }
    .list { display:grid; gap:8px; max-height:45vh; overflow-y:auto; }
    .listItem { display:flex; justify-content:space-between; align-items:center; padding:8px; border:1px solid #223; border-radius:8px; }
    .btnSm { padding:4px 8px; font-size:12px; border-radius:6px; border:1px solid #475569; background:#1f2937; color:#e8edf3; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <h1>KTV 點歌控制器</h1>
    <div>
      <label>Host Peer ID：</label>
      <input id="peer-id" placeholder="輸入 Host ID" />
      <button onclick="connectHost()">連線</button>
    </div>
    <nav>
      <button onclick="switchTab('tab-search')">搜尋 / 點歌</button>
      <button onclick="switchTab('tab-charts')">排行榜</button>
    </nav>
  </header>

  <!-- 搜尋/點歌子頁 -->
  <div id="tab-search" class="tab" style="display:block;">
    <div class="card">
      <form id="searchForm">
        <input id="searchQuery" placeholder="歌名、歌手" style="width:70%;" />
        <button type="submit">搜尋</button>
      </form>
    </div>
    <div class="card">
      <div>搜尋結果</div>
      <div id="searchResults" class="list"></div>
    </div>
    <div class="card">
      <div>播放佇列</div>
      <div id="queue" class="list"></div>
    </div>
  </div>

  <!-- 排行榜子頁 -->
  <div id="tab-charts" class="tab">
    <h3>熱門排行榜</h3>
    <div style="margin-bottom:10px;">
      <button onclick="loadChart('cashbox')">錢櫃</button>
      <button onclick="loadChart('holiday')">好樂迪</button>
      <button onclick="loadChart('silverbox')">SilverBox</button>
      <button onclick="loadChart('starlight')">星光大道</button>
      <button onclick="loadChart('spotify')">Spotify</button>
      <button onclick="loadChart('ytmusic')">YouTube Music</button>
    </div>
    <div id="charts-content" style="border:1px solid #444; border-radius:6px; min-height:600px;">
      👉 請選擇排行榜來源
    </div>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    let conn = null;
    let searchResultsEl = document.getElementById("searchResults");
    let queueEl = document.getElementById("queue");
    let currentQueue = [];

    function switchTab(id) {
      document.querySelectorAll(".tab").forEach(el => el.style.display = "none");
      document.getElementById(id).style.display = "block";
    }

    function connectHost() {
      const peerId = document.getElementById("peer-id").value.trim();
      if (!peerId) return alert("請輸入 Host ID");
      const peer = new Peer();
      conn = peer.connect(peerId);
      conn.on("open", () => alert("✅ 已連線到 Host"));
      conn.on("data", msg => {
        if (msg.type === "sync") {
          currentQueue = msg.payload.queue || [];
          renderQueue();
        }
      });
    }

    function sendToHost(msg) {
      if (conn && conn.open) conn.send(msg);
      else alert("尚未連線到 Host");
    }

    // 搜尋 (YouTube API)
    const API_KEY = "AIzaSyBOdPgWJQOZ1fswTgJRxA2RB3Awf_GrdAE"; // 你的 API Key
    document.getElementById("searchForm").onsubmit = async (e) => {
      e.preventDefault();
      let q = document.getElementById("searchQuery").value;
      if (!q) return;
      let url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=10&q=${encodeURIComponent(q)}&key=${API_KEY}`;
      let res = await fetch(url);
      let data = await res.json();
      searchResultsEl.innerHTML = "";
      (data.items || []).forEach(it => {
        let div = document.createElement("div");
        div.className = "listItem";
        div.innerHTML = `<div>${it.snippet.title}</div>
          <div>
            <button class="btnSm" onclick='enqueue("${it.id.videoId}", "${it.snippet.title}")'>佇列</button>
            <button class="btnSm" onclick='insertNext("${it.id.videoId}", "${it.snippet.title}")'>插播</button>
          </div>`;
        searchResultsEl.appendChild(div);
      });
    };

    function enqueue(id, title) {
      sendToHost({ type: "enqueue", payload: { videoId:id, title:title } });
    }
    function insertNext(id, title) {
      sendToHost({ type: "insertNext", payload: { videoId:id, title:title } });
    }
    function playNow(id, title) {
      sendToHost({ type: "insertNext", payload: { videoId:id, title:title } });
      sendToHost({ type: "next" }); // 讓 Host 立刻切歌
    }
    function removeAt(idx) {
      sendToHost({ type: "removeAt", payload: idx });
    }

    function renderQueue() {
      queueEl.innerHTML = "";
      currentQueue.forEach((q, idx) => {
        let div = document.createElement("div");
        div.className = "listItem";
        div.innerHTML = `<div>${q.title}</div>
          <div>
            <button class="btnSm" onclick='playNow("${q.videoId}", "${q.title}")'>立即播放</button>
            <button class="btnSm" onclick="removeAt(${idx})">刪除</button>
          </div>`;
        queueEl.appendChild(div);
      });
    }

    // 排行榜切換
    function loadChart(source) {
      let url = "", name = "";
      switch (source) {
        case "cashbox": url="https://www.cashboxparty.com/Music/KTVMusic.aspx"; name="錢櫃"; break;
        case "holiday": url="https://www.holiday.com.tw/SongInfo/SongList.aspx?lt=tc&st=top"; name="好樂迪"; break;
        case "silverbox": url="https://www.silverbox.com.tw/rank/"; name="SilverBox"; break;
        case "starlight": url="https://www.starlightktv.com.tw/Song.xsp?exec=Song%2FClass%2Flist"; name="星光大道"; break;
        case "spotify": url="https://charts.spotify.com/charts/overview/global"; name="Spotify"; break;
        case "ytmusic": url="https://charts.youtube.com/charts/TrendingSongs/tw"; name="YouTube Music"; break;
      }
      document.getElementById("charts-content").innerHTML = `
        <iframe src="${url}" width="100%" height="600px" style="border:none; border-radius:6px;"
          onerror="this.parentNode.innerHTML='<a href=${url} target=_blank>👉 開啟 ${name} 排行榜</a>'">
        </iframe>
      `;
    }
  </script>
</body>
</html>
