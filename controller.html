<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>KTV Controller</title>
</head>
<body style="background:#111; color:#eee; font-family:sans-serif; padding:20px;">

  <h1>📱 KTV Controller（點歌端）</h1>
  <input id="peerId" placeholder="輸入 Host Peer ID">
  <button onclick="connect()">連線</button>
  <div id="conn-status"></div>

  <!-- 搜尋區塊 -->
  <h3>搜尋歌曲</h3>
  <input id="search" placeholder="輸入歌名或歌手">
  <button onclick="searchYT()">搜尋</button>
  <div id="results" style="margin-top:10px;"></div>

  <!-- 控制 -->
  <h3>控制播放</h3>
  <button onclick="sendToHost({type:'play'})">▶ 播放</button>
  <button onclick="sendToHost({type:'pause'})">⏸ 暫停</button>
  <button onclick="sendToHost({type:'next'})">⏭ 下一首</button>

  <!-- PeerJS -->
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

  <script>
    const API_KEY = "AIzaSyBOdPgWJQOZ1fswTgJRxA2RB3Awf_GrdAE"; // ← 請換成你的 API Key
    let peer, conn;

    peer = new Peer();
    function connect() {
      const hostId = document.getElementById("peerId").value.trim();
      conn = peer.connect(hostId);
      conn.on("open", () => {
        document.getElementById("conn-status").innerText = "✅ 已連線到 Host";
      });
    }

    function sendToHost(msg) {
      if (conn && conn.open) conn.send(msg);
      else alert("❌ 尚未連線到 Host");
    }

    async function searchYT() {
      const query = document.getElementById("search").value.trim();
      if (!query) return alert("請輸入關鍵字");
      if (API_KEY === "YOUR_YOUTUBE_API_KEY") {
        alert("⚠️ 請先填入有效的 YouTube API Key！");
        return;
      }
      const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=5&q=${encodeURIComponent(query)}&key=${API_KEY}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.error) {
          alert("❌ 搜尋失敗：" + data.error.message);
          console.error("API Error:", data.error);
          return;
        }
        const list = data.items.map(item => {
          const vid = item.id.videoId;
          const title = item.snippet.title.replace(/'/g, "");
          return `<div style="margin:5px 0; padding:5px; border-bottom:1px solid #444;">
            🎵 ${title}<br>
            <button onclick="enqueue('${vid}', '${title}')">佇列</button>
            <button onclick="insertNext('${vid}', '${title}')">插播</button>
          </div>`;
        }).join("");
        document.getElementById("results").innerHTML = list || "— 沒找到結果 —";
      } catch (err) {
        alert("❌ 搜尋請求失敗，請檢查網路或 API Key");
        console.error("Fetch error:", err);
      }
    }

    function enqueue(videoId, title) {
      sendToHost({type:"enqueue", payload:{videoId, title}});
    }
    function insertNext(videoId, title) {
      sendToHost({type:"insertNext", payload:{videoId, title}});
    }
  </script>
</body>
</html>
