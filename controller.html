<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>KTV é»æ­Œæ§åˆ¶å™¨</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0b0f1a; color:#e8edf3; margin:0; }
    header { padding:12px; border-bottom:1px solid #223; }
    h1 { font-size:20px; margin:0; }
    nav { margin-top:8px; display:flex; gap:10px; }
    nav button { padding:8px 12px; border-radius:8px; border:1px solid #475569; background:#1f2937; color:#e8edf3; cursor:pointer; }
    .tab { display:none; padding:12px; }
    .card { padding:12px; border:1px solid #223; border-radius:12px; background:#0f1524; margin-bottom:12px; }
    .list { display:grid; gap:8px; max-height:45vh; overflow-y:auto; }
    .listItem { display:flex; justify-content:space-between; align-items:center; padding:8px; border:1px solid #223; border-radius:8px; }
    .btnSm { padding:4px 8px; font-size:12px; border-radius:6px; border:1px solid #475569; background:#1f2937; color:#e8edf3; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <h1>KTV é»æ­Œæ§åˆ¶å™¨</h1>
    <div>
      <label>Host Peer IDï¼š</label>
      <input id="peer-id" placeholder="è¼¸å…¥ Host ID" />
      <button onclick="connectHost()">é€£ç·š</button>
    </div>
    <nav>
      <button onclick="switchTab('tab-search')">æœå°‹ / é»æ­Œ</button>
      <button onclick="switchTab('tab-charts')">æ’è¡Œæ¦œ</button>
    </nav>
  </header>

  <!-- æœå°‹/é»æ­Œå­é  -->
  <div id="tab-search" class="tab" style="display:block;">
    <div class="card">
      <form id="searchForm">
        <input id="searchQuery" placeholder="æ­Œåã€æ­Œæ‰‹" style="width:70%;" />
        <button type="submit">æœå°‹</button>
      </form>
    </div>
    <div class="card">
      <div>æœå°‹çµæœ</div>
      <div id="searchResults" class="list"></div>
    </div>
    <div class="card">
      <div>æ’­æ”¾ä½‡åˆ—</div>
      <div id="queue" class="list"></div>
    </div>
  </div>

  <!-- æ’è¡Œæ¦œå­é  -->
  <div id="tab-charts" class="tab">
    <h3>ç†±é–€æ’è¡Œæ¦œ</h3>
    <div style="margin-bottom:10px;">
      <button onclick="loadChart('cashbox')">éŒ¢æ«ƒ</button>
      <button onclick="loadChart('holiday')">å¥½æ¨‚è¿ª</button>
      <button onclick="loadChart('silverbox')">SilverBox</button>
      <button onclick="loadChart('starlight')">æ˜Ÿå…‰å¤§é“</button>
      <button onclick="loadChart('spotify')">Spotify</button>
      <button onclick="loadChart('ytmusic')">YouTube Music</button>
    </div>
    <div id="charts-content" style="border:1px solid #444; border-radius:6px; min-height:600px;">
      ğŸ‘‰ è«‹é¸æ“‡æ’è¡Œæ¦œä¾†æº
    </div>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    let conn = null;
    let searchResultsEl = document.getElementById("searchResults");
    let queueEl = document.getElementById("queue");
    let currentQueue = [];

    function switchTab(id) {
      document.querySelectorAll(".tab").forEach(el => el.style.display = "none");
      document.getElementById(id).style.display = "block";
    }

    function connectHost() {
      const peerId = document.getElementById("peer-id").value.trim();
      if (!peerId) return alert("è«‹è¼¸å…¥ Host ID");
      const peer = new Peer();
      conn = peer.connect(peerId);
      conn.on("open", () => alert("âœ… å·²é€£ç·šåˆ° Host"));
      conn.on("data", msg => {
        if (msg.type === "sync") {
          currentQueue = msg.payload.queue || [];
          renderQueue();
        }
      });
    }

    function sendToHost(msg) {
      if (conn && conn.open) conn.send(msg);
      else alert("å°šæœªé€£ç·šåˆ° Host");
    }

    // æœå°‹ (YouTube API)
    const API_KEY = "AIzaSyBOdPgWJQOZ1fswTgJRxA2RB3Awf_GrdAE"; // ä½ çš„ API Key
    document.getElementById("searchForm").onsubmit = async (e) => {
      e.preventDefault();
      let q = document.getElementById("searchQuery").value;
      if (!q) return;
      let url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=10&q=${encodeURIComponent(q)}&key=${API_KEY}`;
      let res = await fetch(url);
      let data = await res.json();
      searchResultsEl.innerHTML = "";
      (data.items || []).forEach(it => {
        let div = document.createElement("div");
        div.className = "listItem";
        div.innerHTML = `<div>${it.snippet.title}</div>
          <div>
            <button class="btnSm" onclick='enqueue("${it.id.videoId}", "${it.snippet.title}")'>ä½‡åˆ—</button>
            <button class="btnSm" onclick='insertNext("${it.id.videoId}", "${it.snippet.title}")'>æ’æ’­</button>
          </div>`;
        searchResultsEl.appendChild(div);
      });
    };

    function enqueue(id, title) {
      sendToHost({ type: "enqueue", payload: { videoId:id, title:title } });
    }
    function insertNext(id, title) {
      sendToHost({ type: "insertNext", payload: { videoId:id, title:title } });
    }
    function playNow(id, title) {
      sendToHost({ type: "insertNext", payload: { videoId:id, title:title } });
      sendToHost({ type: "next" }); // è®“ Host ç«‹åˆ»åˆ‡æ­Œ
    }
    function removeAt(idx) {
      sendToHost({ type: "removeAt", payload: idx });
    }

    function renderQueue() {
      queueEl.innerHTML = "";
      currentQueue.forEach((q, idx) => {
        let div = document.createElement("div");
        div.className = "listItem";
        div.innerHTML = `<div>${q.title}</div>
          <div>
            <button class="btnSm" onclick='playNow("${q.videoId}", "${q.title}")'>ç«‹å³æ’­æ”¾</button>
            <button class="btnSm" onclick="removeAt(${idx})">åˆªé™¤</button>
          </div>`;
        queueEl.appendChild(div);
      });
    }

    // æ’è¡Œæ¦œåˆ‡æ›
    function loadChart(source) {
      let url = "", name = "";
      switch (source) {
        case "cashbox": url="https://www.cashboxparty.com/Music/KTVMusic.aspx"; name="éŒ¢æ«ƒ"; break;
        case "holiday": url="https://www.holiday.com.tw/SongInfo/SongList.aspx?lt=tc&st=top"; name="å¥½æ¨‚è¿ª"; break;
        case "silverbox": url="https://www.silverbox.com.tw/rank/"; name="SilverBox"; break;
        case "starlight": url="https://www.starlightktv.com.tw/Song.xsp?exec=Song%2FClass%2Flist"; name="æ˜Ÿå…‰å¤§é“"; break;
        case "spotify": url="https://charts.spotify.com/charts/overview/global"; name="Spotify"; break;
        case "ytmusic": url="https://charts.youtube.com/charts/TrendingSongs/tw"; name="YouTube Music"; break;
      }
      document.getElementById("charts-content").innerHTML = `
        <iframe src="${url}" width="100%" height="600px" style="border:none; border-radius:6px;"
          onerror="this.parentNode.innerHTML='<a href=${url} target=_blank>ğŸ‘‰ é–‹å•Ÿ ${name} æ’è¡Œæ¦œ</a>'">
        </iframe>
      `;
    }
  </script>
</body>
</html>
