<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>KTV é»æ­Œæ§åˆ¶å™¨</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0b0f1a; color:#e8edf3; margin:0; }
    header { padding:12px; border-bottom:1px solid #223; text-align:center; }
    h1 { font-size:20px; margin:0; }
    .tab { display:none; padding:12px; }
    .card { padding:12px; border:1px solid #223; border-radius:12px; background:#0f1524; margin-bottom:12px; }
    .list { display:grid; gap:8px; max-height:45vh; overflow-y:auto; text-align:left; }
    .listItem { display:flex; justify-content:flex-start; align-items:center; gap:6px; padding:8px; border:1px solid #223; border-radius:8px; }
    .btnSm { padding:4px 8px; font-size:12px; border-radius:6px; border:1px solid #475569; background:#1f2937; color:#e8edf3; cursor:pointer; }
    #toast { position:fixed; top:10px; right:10px; background:#1f2937; color:#fff; padding:8px 12px; border-radius:6px; opacity:0; transition:opacity 0.5s; }
    .light { background:#fff; color:#000; }
    .pink { background:#ffe4f1; color:#c2185b; }
    .festival { background:#800; color:#ffd700; }
  </style>
</head>
<body>
  <header>
    <h1>KTV é»æ­Œæ§åˆ¶å™¨</h1>
    <div id="status">ğŸ”„ å˜—è©¦é€£ç·š Host ä¸­...</div>
    æš±ç¨±ï¼š<input id="nickname" style="width:100px;"/>
    <div>PIN ç¢¼ï¼š<input id="pinBox" placeholder="è¼¸å…¥ PIN"/></div>
    <div>
      <button onclick="switchTab('search')">æœå°‹ / é»æ­Œ</button>
      <button onclick="switchTab('charts')">æ’è¡Œæ¦œ</button>
      <button onclick="switchTab('favorites')">æ”¶è—</button>
      <button onclick="switchTab('history')">æ­·å²</button>
      <button onclick="switchTab('ranking')">é»æ­Œæ’è¡Œ</button>
      <button onclick="switchTab('wall')">è¨Šæ¯ç‰†</button>
    </div>
  </header>

  <!-- æœå°‹ / ä½‡åˆ— -->
  <div id="tab-search" class="tab" style="display:block;">
    <div class="card">
      <form id="searchForm">
        <button type="submit">æœå°‹</button>
        <input id="searchQuery" placeholder="æ­Œåã€æ­Œæ‰‹" style="width:70%;" />
      </form>
    </div>
    <div class="card"><div>æœå°‹çµæœ</div><div id="searchResults" class="list"></div></div>
    <div class="card"><div>æ’­æ”¾ä½‡åˆ—</div><div id="queue" class="list"></div></div>
    <div class="card"><div>ç¾åœ¨æ’­æ”¾</div><div id="nowPlaying"></div><div id="nextSong"></div></div>
  </div>

  <!-- å¤–éƒ¨æ’è¡Œæ¦œ -->
  <div id="tab-charts" class="tab">
    <h3>ç†±é–€æ’è¡Œæ¦œ</h3>
    <button onclick="openChart('ytmusic')">YouTube Music</button>
    <button onclick="openChart('spotify')">Spotify</button>
    <button onclick="openChart('kkbox')">KKBOX</button>
    <button onclick="openChart('apple')">Apple Music</button>
    <button onclick="openChart('cashbox')">éŒ¢æ«ƒ</button>
    <button onclick="openChart('holiday')">å¥½æ¨‚è¿ª</button>
    <button onclick="openChart('star')">æ˜Ÿèšé»</button>
  </div>

  <!-- æ”¶è— -->
  <div id="tab-favorites" class="tab">
    <h3>æ”¶è—æ¸…å–®</h3>
    <div><button onclick="clearFavorites()">æ¸…é™¤å…¨éƒ¨</button></div>
    <div id="favoritesList" class="list"></div>
  </div>

  <!-- æ­·å² -->
  <div id="tab-history" class="tab">
    <h3>æ­·å²ç´€éŒ„</h3>
    <div><button onclick="clearHistory()">æ¸…é™¤å…¨éƒ¨</button></div>
    <div id="historyList" class="list"></div>
  </div>

  <!-- é»æ­Œæ’è¡Œ -->
  <div id="tab-ranking" class="tab">
    <h3>é»æ­Œæ’è¡Œæ¦œ</h3>
    <div id="rankingList" class="list"></div>
  </div>

  <!-- è¨Šæ¯ç‰† -->
  <div id="tab-wall" class="tab">
    <h3>è¨Šæ¯ç‰†</h3>
    <div>
      <button class="btnSm" onclick="sendFeedback('ğŸ‘')">ğŸ‘</button>
      <button class="btnSm" onclick="sendFeedback('ğŸ‘')">ğŸ‘</button>
      <button class="btnSm" onclick="sendFeedback('ğŸ’”')">ğŸ’”</button>
      <button class="btnSm" onclick="sendFeedback('ğŸ˜‚')">ğŸ˜‚</button>
    </div>
    <div id="wallList" class="list"></div>
  </div>

  <div id="toast"></div>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    const API_KEY="AIzaSyBOdPgWJQOZ1fswTgJRxA2RB3Awf_GrdAE";
    let conn, queue=[], history=[], favorites=[], needPIN=false;
    let ranking={}, wall=[], defaultNickname;
    const mahjong=["æ±é¢¨","å—é¢¨","è¥¿é¢¨","åŒ—é¢¨","ç´…ä¸­","ç™¼è²¡","ç™½æ¿"];

    const urlParams=new URLSearchParams(window.location.search);
    const hostId=urlParams.get("host")||"ktv-host";

    function switchTab(tab){
      document.querySelectorAll(".tab").forEach(el=>el.style.display="none");
      document.getElementById("tab-"+tab).style.display="block";
      if(tab==="favorites") renderFavorites();
      if(tab==="history") renderHistory();
      if(tab==="ranking") renderRanking();
      if(tab==="wall") renderWall();
    }

    function showToast(msg){
      const el=document.getElementById("toast");
      el.innerText=msg;
      el.style.opacity=1;
      setTimeout(()=>el.style.opacity=0,2000);
    }

    function connectHost(){
      const peer=new Peer(null, { host:"0.peerjs.com", port:443, path:"/", secure:true, config:{ iceServers:[{urls:"stun:stun.l.google.com:19302"}]} });
      conn=peer.connect(hostId);
      conn.on("open",()=>{
        document.getElementById("status").innerText="âœ… å·²é€£ç·š Host("+hostId+")";
        send({type:"register",name:getNickname()});
      });
      conn.on("data",(msg)=>{
        if(msg.type==="sync"){
          queue=msg.payload.queue||[];
          history=msg.payload.history||[];
          ranking=msg.payload.ranking||{};
          wall=msg.payload.wall||[];
          renderQueue(); renderHistory(); renderRanking(); renderWall();
          document.getElementById("nowPlaying").innerText= msg.payload.current? (msg.payload.current.by? msg.payload.current.by+" é»æ’­ "+msg.payload.current.title: msg.payload.current.title):"æš«ç„¡";
          document.getElementById("nextSong").innerText= queue[0]? "ä¸‹ä¸€é¦–ï¼š"+(queue[0].by? queue[0].by+" é»æ’­ "+queue[0].title: queue[0].title):"";
          applyTheme(msg.payload.theme);
        }
      });
    }
    connectHost();

    function getPIN(){ return document.getElementById("pinBox").value; }
    function send(msg){ if(conn&&conn.open) conn.send(msg); else alert("æœªé€£ç·š Host"); }

    document.addEventListener("DOMContentLoaded",()=>{
      const shuffled=[...mahjong].sort(()=>Math.random()-0.5);
      defaultNickname=shuffled[0];
      if(!localStorage.getItem("nickname")){
        localStorage.setItem("nickname",defaultNickname);
      }
      document.getElementById("nickname").value=localStorage.getItem("nickname");
      document.getElementById("nickname").addEventListener("input",getNickname);
    });

    function getNickname(){
      let v=(document.getElementById("nickname").value||"").trim();
      if(!v){ v=defaultNickname; document.getElementById("nickname").value=v; }
      localStorage.setItem("nickname",v);
      send({type:"rename",name:v});
      return v;
    }

    document.getElementById("searchForm").onsubmit=async(e)=>{
      e.preventDefault();
      let q=document.getElementById("searchQuery").value; if(!q) return;
      let url=`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=10&q=${encodeURIComponent(q)}&key=${API_KEY}`;
      let res=await fetch(url); let data=await res.json();
      const el=document.getElementById("searchResults"); el.innerHTML="";
      (data.items||[]).forEach(it=>{
        const title=it.snippet.title.replace(/"/g,"&quot;");
        el.innerHTML+=`<div class="listItem">
          <button class="btnSm" onclick='send({type:"enqueue",payload:{videoId:"${it.id.videoId}",title:"${title}",by:getNickname()}}); showToast("âœ… å·²é€å‡ºï¼š"+title)'>ä½‡åˆ—</button>
          <button class="btnSm" onclick='send({type:"insertNext",pin:getPIN(),payload:{videoId:"${it.id.videoId}",title:"${title}",by:getNickname()}})'>æ’æ’­</button>
          <button class="btnSm" onclick='addFavorite("${it.id.videoId}","${title}")'>â­</button>
          ${title}
        </div>`;
      });
    };

    function renderQueue(){
      const el=document.getElementById("queue"); el.innerHTML="";
      queue.forEach((q)=>{ el.innerHTML+=`<div class="listItem">${q.by? q.by+" é»æ’­ ":""}${q.title}</div>`; });
    }

    function addFavorite(id,title){
      favorites.push({videoId:id,title});
      localStorage.setItem("favorites",JSON.stringify(favorites));
      alert("å·²æ”¶è—ï¼š"+title);
    }
    function renderFavorites(){
      favorites=JSON.parse(localStorage.getItem("favorites")||"[]");
      const el=document.getElementById("favoritesList"); el.innerHTML="";
      favorites.forEach(f=>{
        el.innerHTML+=`<div class="listItem"><button class="btnSm" onclick='send({type:"enqueue",payload:${JSON.stringify(f)}})'>æ’­æ”¾</button>${f.title}</div>`;
      });
    }
    function clearFavorites(){ favorites=[]; localStorage.removeItem("favorites"); renderFavorites(); }

    function renderHistory(){
      const el=document.getElementById("historyList"); el.innerHTML="";
      history.slice().reverse().forEach(h=>{
        el.innerHTML+=`<div class="listItem"><button class="btnSm" onclick='send({type:"enqueue",payload:${JSON.stringify(h)}})'>å†å”±</button>${h.by? h.by+" é»æ’­ ":""}${h.title}</div>`;
      });
    }
    function clearHistory(){ history=[]; renderHistory(); }

    function renderRanking(){
      const el=document.getElementById("rankingList"); el.innerHTML="";
      Object.entries(ranking).sort((a,b)=>b[1]-a[1]).forEach(([name,count],i)=>{
        el.innerHTML+=`<div class="listItem">${i+1}. ${name} ${count} é¦–</div>`;
      });
    }

    function renderWall(){
      const el=document.getElementById("wallList"); el.innerHTML="";
      wall.forEach(m=>{ el.innerHTML+=`<div class="listItem">${m.by}ï¼š${m.emoji}</div>`; });
    }
    function sendFeedback(emoji){ send({type:"feedback",by:getNickname(),emoji}); }

    function openChart(source){
      let url="";
      switch(source){
        case "ytmusic": url="https://charts.youtube.com/charts/TrendingSongs/tw"; break;
        case "spotify": url="https://charts.spotify.com/charts/overview/global"; break;
        case "kkbox": url="https://kma.kkbox.com/charts/weekly/newrelease?lang=tc"; break;
        case "apple": url="https://music.apple.com/tw/browse/top-charts"; break;
        case "cashbox": url="https://www.cashboxparty.com.tw"; break;
        case "holiday": url="https://www.holiday.com.tw"; break;
        case "star": url="https://www.moneydj.com/Ktv/StarLight"; break;
      }
      if(url) window.open(url,"_blank");
    }

    function applyTheme(theme){
      document.body.className="";
      if(theme==="light") document.body.classList.add("light");
      if(theme==="pink") document.body.classList.add("pink");
      if(theme==="festival") document.body.classList.add("festival");
    }
  </script>
</body>
</html>